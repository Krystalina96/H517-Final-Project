<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <title>Project 2: Nolasco</title>
  </head>
  <body>
    <!-- Side navigation -->
    <div class="sidenav">
        <a href="visualization.html">Visualization</a>
        <a href="about.html">About</a>
        <a href="video.html">Video</a>
    </div>

    <!-- Page content -->
    <div class="main">
        <div class="header">COVID-19</div>
        <div id="sub-title">a visualization by Krystal Nolasco</div>

        <div class="grid-container">
          <div class="item1">
              <svg id="total-cases-grid"></svg>
          </div>
          <div class="item2">
              <div id="map">
                  <p class="sub-header">Map of Outbreak</p>
                  <p class="information-text" id="map-information-text">Hover over states on the map for additional information.</p>
                  <svg id="map-grid"></svg>
                  <svg id="map-legend"></svg>
                  <div id="map-tooltip"></div>
              </div>
          </div>

          <div class="item3">
            <div id="line-graph">
                <p class="sub-header">Timeline of Deaths Per Day</p>
                <p class="information-text">Hover over bars on the chart to visualize deaths by date on the map.</p>
                <svg id="line-graph-grid"></svg>
            </div>
          </div>

          <div class="item4">
              <p class="sub-sub-header">Deaths by Age Group</p>
              <svg id="age-graph-grid"></svg>
          </div>
        </div>

        <div class="footer">&copy; Copyright 2022 Krystal Nolasco</div>
    </div>
  </body>
  <script>

    //var colors = ["#fafa6e","#9cdf7c","#4abd8c","#00968e", "#106e7c", "#2a4858"];
    var colors = ["#ccffcc", "#7fcdbb", "#41b6c4", "#1d91c0", "#225da8", "#003366"];

    //function for adding commas to numbers
    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    };

    // US TOTAL CASES ********************************************
    d3.csv('data/united_states_covid19_cases_deaths_and_testing_by_state.csv', function (data) {
      //console.log(data);

      var svg_total_cases = d3.select("#total-cases-grid")
        .attr("width", 300)
        .attr("height", 100)
        .style("border", "solid");

      svg_total_cases.append("text")
        .attr('x', '50%')
        .attr('y', 20)
        .style('text-anchor', 'middle')
        .text("Total Cases");

      var totalCases = data[data.length - 1].total_cases;

      svg_total_cases.append("text")
        .attr('x', '50%')
        .attr('y', 70)
        .style('font-size', 40)
        .style('font-weight', 'bold')
        .style('text-anchor', 'middle')
        .text(numberWithCommas(totalCases));




    });


    // US MAP OF TOTAL CASES BY STATE ********************************************

    //map dimensions
    var mapMargin = {top: 0, right: 20, bottom: 20, left: 20},
        mapWidth = 960 - mapMargin.left - mapMargin.right,
        mapHeight = 500 - mapMargin.top - mapMargin.bottom;

    var projection = d3.geo.albersUsa()
        .translate([mapWidth/2, mapHeight/2])
        .scale([1000]);

    var path = d3.geo.path().projection(projection);

    var color = d3.scale.linear().range(colors);

    //create SVG map area
    var svg_map = d3.select("#map-grid")
        .attr("width", mapWidth + mapMargin.left + mapMargin.right)
        .attr("height", mapHeight + mapMargin.top + mapMargin.bottom)
        .style('border', 'solid');

    //define legend text
    var legendText = ["4k - 156.3k", "235.8k - 444.6k", "478.0k - 833.7k", "928.6k - 1.5M", "1.6M - 2.8M", "3.1M - 9.1M"];

    //create SVG area for map legend
    var svg_legend = d3.select("#map-legend")
        .attr("width", 140)
        .attr("height", 200)
        //.style('border', 'solid')
        .data(color.domain().slice().reverse())
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    var squareDimensions = 20;

    var legend_squares = svg_legend.selectAll("rect")
        .data([0, squareDimensions + 10, squareDimensions*2 + 20, squareDimensions*3 + 30, squareDimensions*4 + 40, squareDimensions*5 + 50])
        .enter()
        .append("g")
        .classed("rect", true);

    var legendColors = d3.scale.ordinal().range(colors);

    legend_squares.append("rect")
        .attr("width", squareDimensions)
        .attr("height", squareDimensions)
        .attr("x", 10)
        .attr('y', function(d) { return d; })
        .attr('fill', function (d, i) {return legendColors(i); });

    var legend_labels = svg_legend.selectAll("text")
        .data([16, 46, 76, 106, 136, 166])
        .enter()
        .append("g")
        .classed("text", true);

    var legendLabels = d3.scale.ordinal().range(legendText);

    legend_labels.append("text")
        .attr("x", 40)
        .attr("y", function(d) {return d;})
        .text(function(d, i) {return legendLabels(i); });

    //tooltip
    var svg_tooltip = d3.select("#map-tooltip")
        .style("opacity", 0)
        .style("border", "solid");

    //load in data
    d3.csv('data/united_states_covid19_cases_deaths_and_testing_by_state.csv', function (data) {
        //console.log(data);



        d3.json("data/us-states.json", function (json) {
            //console.log(json);

            //loop through each state data value in the .csv file
            for (i = 0; i < data.length; i++) {
                //grab state name
                var dataState = data[i].state;
                //console.log(dataState);

                //grab number of covid cases
                var dataValue = data[i].total_cases;

                //find the matching state in the json file
                for (j = 0; j < json.features.length; j++) {
                    var jsonState = json.features[j].properties.name;

                    if (dataState == jsonState) {
                        //copy the data value into the json
                        json.features[j].properties.cases = dataValue;

                        break;
                    }
                }
            }

            //draw map
            var drawMap = svg_map.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("stroke", "black")
                .style("stroke-width", "1")
                .style("fill", function (d) {
                    //get data value
                    var value = d.properties.cases;

                    if (value >= 4000 && value <= 156300) {
                        return color(0);
                    } else if (value >= 235700 && value <= 444700) {
                        return color(1);
                    } else if (value >= 478000 && value <= 833700) {
                        return color(2);
                    } else if (value >= 928600 && value < 1500000) {
                        return color(3);
                    } else if (value > 1500000 && value <= 2800000) {
                        return color(4);
                    } else if (value >= 3000000 && value <= 9200000) {
                        return color(5);
                    } else {
                        return "white";
                    }
                })
                .on("mouseover", function(d) {
                  //d3.select("#map-information-text").html(d.properties.name)


                    svg_tooltip.transition()
                        .duration(200)
                        .style("opacity", .9)
                        //.html(d.properties.name)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");

                    d3.select("#map-tooltip")
                      .html("<b style='font-size:18px'>" + d.properties.name + "</b><br><b style='font-size:14px'>Number of Cases:</b> " + numberWithCommas(Math.round(d.properties.cases)) );
                      //.html(d.properties.name + "<br> Number of Cases: " + Math.round(d.properties.cases) );


                })
                .on("mouseout", function(d) {
                    svg_tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        })
    });

    // LINE GRAPH CASES OVER TIME ********************************************

    //line graph dimensions
    var lineMargin = {top: 20, right: 20, bottom: 50, left: 100},
        lineWidth = 960 - lineMargin.left - lineMargin.right,
        lineHeight = 500 - lineMargin.top - lineMargin.bottom;

    //parse dates
    var parseDate = d3.time.format("%m/%d/%Y").parse;

    var max = 0;
    var minDate = new Date();
    var maxDate = new Date();

    var lineData = [];
    var minSubmissionDate = "",
        submissionDate = "",
        tempCases = 0;

    ///*
    //load in data
    d3.csv("data/United_States_COVID-19_Cases_and_Deaths_by_State_over_Time.csv", function(data) {
      //grab min date
      minSubmissionDate = data[0].submission_date;

      for(i = 0; i < data.length; i++) {
        submissionDate = data[i].submission_date;
        //console.log(submissionDate);

        if(submissionDate.trim() == minSubmissionDate.trim()) {
          //console.log(data[i].tot_cases, Number(data[i].tot_cases));
          tempCases = tempCases + Number(data[i].tot_cases);
          //lineData.push({date: submissionDate, cases: })

        } else {
          //tempCases = 0;
          lineData.push({date: parseDate(minSubmissionDate), cases: tempCases});
          minSubmissionDate = data[i].submission_date;
          tempCases = 0;
        }
      };

      //console.log(data.length);

      max = d3.max(lineData, function(d) {return d.cases });
      minDate = parseDate(data[0].submission_date);
      maxDate = parseDate(data[data.length - 1].submission_date);

      //scales & axes
      var line_y = d3.scale.linear()
        .domain([0,max])
        .range([lineHeight,0]);

      var line_x = d3.time.scale()
        .domain([minDate,maxDate])
        //.domain([new Date(2020, 1, 22), new Date(2022, 4, 19)])
        .range([0,lineWidth]);


      var line_yAxis = d3.svg.axis()
        .orient("left")
        .scale(line_y);

      var line_xAxis = d3.svg.axis()
        .orient("bottom")
        .scale(line_x);

      var line = d3.svg.line()
        .x(function(d){ return line_x(d.date); })
        .y(function(d){ return line_y(d.cases); })
        .interpolate("cardinal");

      //line graph svg
      var svg_line = d3.select("#line-graph-grid")
        .attr("height", lineHeight + lineMargin.top + lineMargin.bottom)
        .attr("width", lineWidth + lineMargin.left + lineMargin.right)
        .style("border", "solid");

      var lineGroup = svg_line.append("g")
        .attr("class", "lineGroup")
        .attr("transform", "translate(100, 20)");

      lineGroup.append("path")
        .attr("class", "line")
        .attr("d", function(d) { return line(lineData); })
        .style("fill", "none")
        .style("stroke-width", 3)
        .style("stroke", colors[1]);

      lineGroup.append("g")
        .attr("class", "line-axis x")
        .attr("transform", "translate(0," + lineHeight + ")")
        .call(line_xAxis);

      lineGroup.append("g")
        .attr("class", "line-axis y")
        .call(line_yAxis);

        //console.log(lineData);

    })
    //*/

    /*

      d3.csv("data/United_States_COVID-19_Cases_and_Deaths_by_State_over_Time.csv")
        .row(function(d) { return { date: parseDate(d.submission_date), cases: Number(d.tot_cases)}; })
        .get(function(error, rows) {
          max = d3.max(rows, function(d) {return d.cases; });
          minDate = d3.min(rows, function(d) { return d.date; });
          maxDate = d3.max(rows, function(d) { return d.date; });

          //scales & axes
          var line_y = d3.scale.linear()
            .domain([0,max])
            .range([lineHeight,0]);

          var line_x = d3.time.scale()
            .domain([minDate,maxDate])
            .range([0,lineWidth]);

          var line_yAxis = d3.svg.axis()
            .orient("left")
            .scale(line_y);

          var line_xAxis = d3.svg.axis()
            .orient("bottom")
            .scale(line_x);

          var line = d3.svg.line()
      			.x(function(d){ return line_x(d.date); })
      			.y(function(d){ return line_y(d.cases); })
      			.interpolate("cardinal");

          //line graph svg
          var svg_line = d3.select("#line-graph-grid")
            .attr("height", 1000)
            .attr("width", "100%")
            .style("border", "solid");

          var lineGroup = svg_line.append("g")
            .attr("class", "lineGroup")
            .attr("transform", "translate(50, 20)");

          lineGroup.append("path")
            .attr("class", "line")
            .attr("d", function(d) { return line(rows); })
            .style("fill", "none")
            .style("stroke-width", 3)
            .style("stroke", "red");

          lineGroup.append("g")
            .attr("class", "line-axis x")
            .attr("transform", "translate(0," + lineHeight + ")")
            .call(line_xAxis);

          lineGroup.append("g")
            .attr("class", "line-axis y")
            .call(line_yAxis);
        });
        */



  </script>
