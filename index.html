<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <title>Project 2: Nolasco</title>
  </head>
  <body>
    <!-- Side navigation -->
    <div class="sidenav">
        <a href="visualization.html">Visualization</a>
        <a href="about.html">About</a>
        <a href="video.html">Video</a>
    </div>

    <!-- Page content -->
    <div class="main">
        <div class="header">COVID-19</div>
        <div id="sub-title">a visualization by Krystal Nolasco</div>

        <div class="grid-container">
            <div class="item1">
                <div id="map">
                    <p class="sub-header">Map of Outbreak</p>
                    <p class="information-text" id="map-information-text">Hover over states on the map for additional information.</p>
                    <svg id="map-grid"></svg>
                    <svg id="map-legend"></svg>
                    <div id="map-tooltip"></div>
                </div>

                <div id="timeline">
                    <p class="sub-header">Timeline of Deaths Per Day</p>
                    <p class="information-text">Hover over bars on the chart to visualize deaths by date on the map.</p>
                    <svg id="timeline-grid"></svg>
                </div>
            </div>

            <div class="item2">
                <p class="sub-sub-header">Deaths by Gender</p>
                <svg id="gender-graph-grid"></svg>
            </div>

            <div class="item3">
                <p class="sub-sub-header">Deaths by Age Group</p>
                <svg id="age-graph-grid"></svg>
            </div>
        </div>

        <div class="footer">&copy; Copyright 2022 Krystal Nolasco</div>
    </div>
  </body>
  <script>

    //var colors = ["#fafa6e","#9cdf7c","#4abd8c","#00968e", "#106e7c", "#2a4858"];
    var colors = ["#ccffcc", "#7fcdbb", "#41b6c4", "#1d91c0", "#225da8", "#003366"]

    var mapMargin = {top: 0, right: 20, bottom: 20, left: 20},
        mapWidth = 960 - mapMargin.left - mapMargin.right,
        mapHeight = 500 - mapMargin.top - mapMargin.bottom;

    var projection = d3.geo.albersUsa()
        .translate([mapWidth/2, mapHeight/2])
        .scale([1000]);

    var path = d3.geo.path()
        .projection(projection);

    var color = d3.scale.linear()
        //.range(["#9A6FD6","#8C60C6","#7E51B7","#6A3EA3", "#5E2F98", "#4D2082"]);
        //.range(["#fafa6e","#9cdf7c","#4abd8c","#00968e", "#106e7c", "#2a4858"]);
        .range(colors);

    //create SVG map area
    var svg_map = d3.select("#map-grid")
        .attr("width", mapWidth + mapMargin.left + mapMargin.right)
        .attr("height", mapHeight + mapMargin.top + mapMargin.bottom)
        .style('border', 'solid');

    //define legend text
    var legendText = ["4k - 156.3k", "235.8k - 444.6k", "478.0k - 833.7k", "928.6k - 1.5M", "1.6M - 2.8M", "3.1M - 9.1M"];

    //create SVG area for map legend
    var svg_legend = d3.select("#map-legend")
        .attr("width", 140)
        .attr("height", 200)
        //.style('border', 'solid')
        .data(color.domain().slice().reverse())
        .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

    var squareDimensions = 20;

    var legend_squares = svg_legend.selectAll("rect")
        .data([0, squareDimensions + 10, squareDimensions*2 + 20, squareDimensions*3 + 30, squareDimensions*4 + 40, squareDimensions*5 + 50])
        .enter()
        .append("g")
        .classed("rect", true);

    var legendColors = d3.scale.ordinal().range(colors);

    legend_squares.append("rect")
        .attr("width", squareDimensions)
        .attr("height", squareDimensions)
        .attr("x", 10)
        .attr('y', function(d) { return d; })
        .attr('fill', function (d, i) {return legendColors(i); });

    var legend_labels = svg_legend.selectAll("text")
        .data([16, 46, 76, 106, 136, 166])
        .enter()
        .append("g")
        .classed("text", true);

    var legendLabels = d3.scale.ordinal().range(legendText);

    legend_labels.append("text")
        .attr("x", 40)
        .attr("y", function(d) {return d;})
        .text(function(d, i) {return legendLabels(i); });

    //tooltip
    var svg_tooltip = d3.select("#map-tooltip")
        .style("opacity", 0)
        .style("border", "solid");

    //load in data
    d3.csv('data/united_states_covid19_cases_deaths_and_testing_by_state.csv', function (data) {
        //console.log(data);

        //function for adding commas to numbers
        function numberWithCommas(x) {
          return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        d3.json("data/us-states.json", function (json) {
            //console.log(json);

            //loop through each state data value in the .csv file
            for (i = 0; i < data.length; i++) {
                //grab state name
                var dataState = data[i].state;
                //console.log(dataState);

                //grab number of covid cases
                var dataValue = data[i].total_cases;

                //find the matching state in the json file
                for (j = 0; j < json.features.length; j++) {
                    var jsonState = json.features[j].properties.name;

                    if (dataState == jsonState) {
                        //copy the data value into the json
                        json.features[j].properties.cases = dataValue;

                        break;
                    }
                }
            }

            //draw map
            var drawMap = svg_map.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("stroke", "black")
                .style("stroke-width", "1")
                .style("fill", function (d) {
                    //get data value
                    var value = d.properties.cases;

                    if (value >= 4000 && value <= 156300) {
                        return color(0);
                    } else if (value >= 235700 && value <= 444700) {
                        return color(1);
                    } else if (value >= 478000 && value <= 833700) {
                        return color(2);
                    } else if (value >= 928600 && value < 1500000) {
                        return color(3);
                    } else if (value > 1500000 && value <= 2800000) {
                        return color(4);
                    } else if (value >= 3000000 && value <= 9200000) {
                        return color(5);
                    } else {
                        return "white";
                    }
                })
                .on("mouseover", function(d) {
                  //d3.select("#map-information-text").html(d.properties.name)


                    svg_tooltip.transition()
                        .duration(200)
                        .style("opacity", .9)
                        //.html(d.properties.name)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");

                    d3.select("#map-tooltip")
                      .html("<b style='font-size:18px'>" + d.properties.name + "</b><br><b style='font-size:14px'>Number of Cases:</b> " + numberWithCommas(Math.round(d.properties.cases)) );
                      //.html(d.properties.name + "<br> Number of Cases: " + Math.round(d.properties.cases) );


                })
                .on("mouseout", function(d) {
                    svg_tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });


        })

    })



  </script>
